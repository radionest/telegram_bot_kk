# Telegram AI Bot

Телеграм бот для анализа сообщений в группах с помощью AI (Google Gemini и Groq).

## Функциональность

- Работает в группах и супергруппах
- Автоматически анализирует сообщения с вопросами или просьбами о помощи
- Отвечает реакцией (🤖) на короткие ответы или сообщением на развернутые
- Фильтрует сообщения по ключевым словам и минимальной длине
- Динамический выбор группы для модерации (для администратора бота)

## Установка

1. Клонируйте репозиторий
2. Установите PDM если еще не установлен: `pip install pdm`
3. Установите зависимости: `pdm install`
4. Скопируйте `.env.example` в `.env` и заполните токены:
   - `TELEGRAM_BOT_TOKEN` - токен бота от @BotFather
   - `GEMINI_API_KEY` - API ключ от Google AI Studio
   - `GROUP_CHAT_ID` - ID группы для модерации по умолчанию
   - `SUPERUSER_ID` (опционально) - ID пользователя с правами администратора бота
   - `MIN_MESSAGE_LENGTH` (опционально) - минимальная длина сообщения для анализа
   - `REACTION_EMOJI` (опционально) - эмодзи для реакций
   - `VIOLATION_TIME_WINDOW` (опционально) - временное окно для отслеживания нарушений

## Настройка бота в Telegram

1. Создайте бота через @BotFather
2. Отключите режим приватности командой `/setprivacy` -> выберите бота -> `Disable`
3. Добавьте бота в группу как администратора

## Запуск

```bash
pdm run python src/main.py
```

## Структура проекта

```
.
├── src/
│   ├── main.py                      # Точка входа приложения
│   ├── config/
│   │   └── settings.py              # Настройки и переменные окружения
│   ├── routers/
│   │   ├── admin.py                 # Обработчики административных команд
│   │   ├── message_handlers.py      # Обработчики сообщений в группах
│   │   └── private.py               # Обработчики личных сообщений
│   ├── models/
│   │   ├── analysis.py              # Модели данных для анализа
│   │   ├── base_topic_storage.py    # Базовый класс для хранения топиков
│   │   └── message_history.py       # Модель истории сообщений
│   ├── services/                    # Бизнес-логика
│   │   ├── ai_client.py             # Базовый клиент для AI
│   │   ├── chat_manager.py          # Управление чатами
│   │   ├── group_tracker.py         # Отслеживание групп
│   │   ├── memory_topic_storage.py  # Хранение топиков в памяти
│   │   ├── message_history_storage.py # Хранение истории сообщений
│   │   └── response_manager.py      # Управление ответами
│   ├── middlewares/                 # Промежуточные обработчики
│   │   ├── message_history_middleware.py # История сообщений
│   │   └── topic_update_middleware.py    # Обновление топиков
│   ├── filters/                     # Фильтры сообщений
│   │   ├── base.py                  # Базовые фильтры
│   │   └── chat_filters.py          # Фильтры для чатов
│   ├── states/                      # FSM состояния
│   └── utils/
│       ├── gemini_client.py         # Клиент для работы с Gemini API
│       ├── groq_client.py           # Клиент для работы с Groq API
│       ├── group_selection.py       # Утилиты для выбора группы
│       └── logger.py                # Конфигурация логирования
├── data/                        # Директория для данных (создается автоматически)
├── logs/                        # Директория для логов (создается автоматически)
├── .env.example                 # Пример файла с переменными окружения
├── .gitignore
├── CLAUDE.md                    # Руководство по стилю кода
├── install.sh                   # Скрипт установки
└── pyproject.toml               # Конфигурация проекта и зависимости
```

## Команды бота

- `/start` - Приветственное сообщение
- `/help` - Справка по командам
- `/topics` - Список доступных тем для обсуждения
- `/set_group` - Выбор группы для модерации (только для администратора)

## Настройки анализа

В файле `src/config/settings.py` можно настроить:
- `ANALYZE_KEYWORDS` - ключевые слова для фильтрации сообщений
- `MIN_MESSAGE_LENGTH` - минимальная длина сообщения для анализа
- `REACTION_EMOJI` - эмодзи для реакций

## Разработка

### Установка зависимостей для разработки
```bash
pdm install --dev
```

### Проверка кода
```bash
# Форматирование кода
pdm run ruff format src/

# Проверка линтером
pdm run ruff check src/

# Проверка типов
pdm run mypy src/
```

### Pre-commit хуки
Для автоматической проверки кода перед коммитом:
```bash
pdm run pre-commit install
```